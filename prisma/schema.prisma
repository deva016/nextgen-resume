// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model Resume {
  id     String @id @default(cuid())
  userId String

  title       String?
  description String?

  photoUrl    String?
  colorHex    String  @default("#000000")
  borderStyle String  @default("squircle")
  template    String  @default("modern")
  summary     String?
  firstName   String?
  lastName    String?
  jobTitle    String?
  city        String?
  country     String?
  phone       String?
  email       String?

  workExperiences WorkExperience[]
  educations      Education[]
  projects        Project[]
  certifications  Certification[]
  skills          String?
  strengths       String?
  languages       String?
  atsScore        ATSScore?
  jobRecommendations JobRecommendation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("resumes")
}

model JobRecommendation {
  id       String   @id @default(cuid())
  userId   String
  resumeId String
  resume   Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  // Job details (cached from API)
  jobId          String // External API job ID
  title          String
  company        String
  location       String
  salary         String?
  description    String @db.Text
  url            String
  postedDate     DateTime
  contractType   String
  category       String?

  // Matching metadata  
  matchScore     Int // 0-100
  matchReasons   String[]
  keywordMatches String[]
  missingKeywords String[]

  // User interaction
  viewed  Boolean @default(false)
  saved   Boolean @default(false)
  applied Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("job_recommendations")
  @@index([userId, resumeId])
  @@index([matchScore])
}

model ATSScore {
  id       String @id @default(cuid())
  resumeId String @unique
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  overallScore    Int // 0-100
  keywordScore    Int // 0-100
  formattingScore Int // 0-100
  contentScore    Int // 0-100

  suggestions     String[] // Array of improvement suggestions
  matchedKeywords String[]
  missingKeywords String[]

  jobDescription String? // Optional job description for matching

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ats_scores")
}

model WorkExperience {
  id String @id @default(cuid())

  position    String?
  company     String?
  startDate   DateTime?
  endDate     DateTime?
  description String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_experiences")
}

model Education {
  id String @id @default(cuid())

  degree    String?
  school    String?
  startDate DateTime?
  endDate   DateTime?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("educations")
}

model Project {
  id          String  @id @default(cuid())
  name        String?
  description String?
  year        String?
  link        String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

model Certification {
  id        String  @id @default(cuid())
  name      String?
  yearRange String?
  link      String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("certifications")
}

model UserSubscription {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  stripeCustomerId        String   @unique
  stripeSubscriptionId    String   @unique
  stripePriceId           String
  stripeCurrentPeriodEnd  DateTime
  stripeCancelAtPeriodEnd Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_subscriptions")
}
